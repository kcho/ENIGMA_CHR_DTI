FROM centos:7.5.1804

MAINTAINER Kevin Cho <kevincho@bwh.harvard.edu>

# set up user and working directory
WORKDIR /
ENV USER="root"

COPY startup.sh /

# primary image for deployment ##
# libraries and commands for FSL
RUN yum -y update > /dev/null 2>&1 && \
    yum -y install epel-release wget which file bzip2 openblas-devel libquadmath && \
    yum clean all

# install FSL
RUN echo "Downloading FSL installer" && \
    wget https://fsl.fmrib.ox.ac.uk/fsldownloads/fslinstaller.py -O fslinstaller.py > /dev/null 2>&1 && \
    echo "Installing FSL" && \
    python fslinstaller.py -V 6.0.4 -d `pwd`/fsl-6.0.4-centos7 -p > /dev/null 2>&1

# setup FSL environment
RUN export FSLDIR="$PWD/fsl-6.0.4-centos7" && \
    echo "export FSLDIR=$PWD/fsl-6.0.4-centos7" >> ~/.bashrc && \
    export PATH="$FSLDIR/bin/:$PATH" && \
    echo "export PATH=\$FSLDIR/bin/:\$PATH" >> ~/.bashrc && \
    source $FSLDIR/etc/fslconf/fsl.sh && \
    echo "source $FSLDIR/etc/fslconf/fsl.sh" >> ~/.bashrc

# apply patch
#RUN echo "Installing FSL patch" && \
    #$FSLDIR/fslpython/bin/conda install -y -n fslpython -c conda-forge deprecation==1.* > /dev/null 2>&1 && \
    #$FSLDIR/fslpython/bin/conda clean --all

# install python
RUN echo "Downloading miniconda3 installer" && \
    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O Miniconda3-latest-Linux-x86_64.sh > /dev/null 2>&1 && \
    /bin/bash Miniconda3-latest-Linux-x86_64.sh -b -p miniconda3/ && \
    rm -f Miniconda3-latest-Linux-x86_64.sh && \
    source miniconda3/bin/activate && \
    echo "source $PWD/miniconda3/bin/activate" >> ~/.bashrc

# install ANTs=2.3.0
RUN ${PWD}/miniconda3/bin/conda config --append channels pnlbwh
RUN ${PWD}/miniconda3/bin/conda install -c pnlbwh -y ants
RUN export ANTSPATH="$PWD/miniconda3/bin/"
RUN echo "export ANTSPATH=$PWD/miniconda3/bin/" >> ~/.bashrc

# libraries and commands for TBSS
RUN yum -y install git bc unzip gcc && \
    yum clean all && \
    rm -rf /var/yum/cache/

# clone TBSS
RUN git clone https://github.com/pnlbwh/tbss.git
RUN git clone https://github.com/pnlbwh/eddy-squeeze
RUN git clone https://github.com/kcho/ENIGMA_CHR_DTI

# install TBSS
RUN /bin/bash tbss/install.sh setup

# python settings
RUN echo "alias ls=\"ls --color\"" >> ~/.bashrc

RUN chmod +x /startup.sh
RUN cat /startup.sh

#CMD ["/bin/bash"]

#ENTRYPOINT ["/startup.sh"]
